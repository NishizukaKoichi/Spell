name: Spell Execution Example

# This workflow can be triggered by:
# 1. workflow_dispatch (manual trigger with inputs)
# 2. repository_dispatch (webhook trigger with client_payload)

on:
  workflow_dispatch:
    inputs:
      cast_id:
        description: 'Cast ID from Spell Platform'
        required: true
        type: string
      spell_key:
        description: 'Spell key'
        required: true
        type: string
      input_data:
        description: 'JSON input data for the spell'
        required: false
        type: string
        default: '{}'

  repository_dispatch:
    types: [spell.cast]

jobs:
  execute:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse inputs
        id: parse
        run: |
          # For workflow_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "cast_id=${{ github.event.inputs.cast_id }}" >> $GITHUB_OUTPUT
            echo "spell_key=${{ github.event.inputs.spell_key }}" >> $GITHUB_OUTPUT
            echo "input_data=${{ github.event.inputs.input_data }}" >> $GITHUB_OUTPUT
          # For repository_dispatch
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "cast_id=${{ github.event.client_payload.cast_id }}" >> $GITHUB_OUTPUT
            echo "spell_key=${{ github.event.client_payload.spell_key }}" >> $GITHUB_OUTPUT
            echo "input_data=${{ github.event.client_payload.input_data }}" >> $GITHUB_OUTPUT
          fi

      - name: Echo inputs
        run: |
          echo "Cast ID: ${{ steps.parse.outputs.cast_id }}"
          echo "Spell Key: ${{ steps.parse.outputs.spell_key }}"
          echo "Input Data: ${{ steps.parse.outputs.input_data }}"

      # ============================================
      # YOUR SPELL LOGIC GOES HERE
      # ============================================
      # Example: Run a Python script, Node.js app, or any other process

      - name: Setup Node.js (if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Execute Spell Logic
        run: |
          # Example: Parse input and execute
          INPUT='${{ steps.parse.outputs.input_data }}'
          echo "Executing spell with input: $INPUT"

          # Your actual spell execution here
          # Example: node scripts/execute-spell.js "$INPUT"
          # Example: python scripts/execute.py "$INPUT"

          # For demo purposes, create a simple result file
          mkdir -p output
          echo "Spell execution completed successfully" > output/result.txt
          echo "Cast ID: ${{ steps.parse.outputs.cast_id }}" >> output/result.txt
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> output/result.txt

      # ============================================
      # Upload Results as Artifacts
      # ============================================
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spell-result-${{ steps.parse.outputs.cast_id }}
          path: output/
          retention-days: 7

      # Optional: Send status updates back to Spell Platform
      # - name: Notify success
      #   if: success()
      #   run: |
      #     curl -X POST https://api.magicspell.io/v1/casts/${{ steps.parse.outputs.cast_id }}/status \
      #       -H "Authorization: Bearer ${{ secrets.SPELL_API_KEY }}" \
      #       -H "Content-Type: application/json" \
      #       -d '{"status": "completed", "message": "Execution succeeded"}'
