# ãƒ‘ã‚¹ã‚­ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹èªè¨¼ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

## ğŸ“‹ æ¦‚è¦

- **èªè¨¼æ–¹å¼**: WebAuthn (ãƒ‘ã‚¹ã‚­ãƒ¼)
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: NextAuth v5 with JWT
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: SimpleWebAuthn
- **å¯¾å¿œãƒ‡ãƒã‚¤ã‚¹**: ç”Ÿä½“èªè¨¼ (æŒ‡ç´‹ã€é¡”èªè¨¼) ã¾ãŸã¯ãƒ‡ãƒã‚¤ã‚¹PIN

## ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„:

```bash
# å¿…é ˆ: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®URL
NEXTAUTH_URL=http://localhost:3000

# å¿…é ˆ: NextAuth ã‚»ãƒƒã‚·ãƒ§ãƒ³æš—å·åŒ–ã‚­ãƒ¼ (ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆ)
# openssl rand -base64 32
AUTH_SECRET=your-generated-secret-key

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
DATABASE_URL=postgresql://user:password@localhost:5432/spell
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# Prisma ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
pnpm prisma migrate dev

# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
pnpm db:seed
```

### 3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

```bash
pnpm dev
```

## ğŸš€ èªè¨¼ãƒ•ãƒ­ãƒ¼

### æ–°è¦ç™»éŒ² (Sign Up)

1. `/auth/signup` ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
3. ã€ŒSign up with Passkeyã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ–ãƒ©ã‚¦ã‚¶/OSã®ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã†
5. ç”Ÿä½“èªè¨¼ã¾ãŸã¯PINã§ç¢ºèª
6. è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### ã‚µã‚¤ãƒ³ã‚¤ãƒ³ (Sign In)

1. `/auth/signin` ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€ŒSign in with Passkeyã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ–ãƒ©ã‚¦ã‚¶/OSãŒç™»éŒ²æ¸ˆã¿ã®ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’è¡¨ç¤º
4. ä½¿ç”¨ã™ã‚‹ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’é¸æŠ
5. ç”Ÿä½“èªè¨¼ã¾ãŸã¯PINã§ç¢ºèª
6. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**æ³¨**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å…¥åŠ›ã¯ä¸è¦ã§ã™ã€‚ãƒ‘ã‚¹ã‚­ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ã—ã¾ã™ã€‚

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

### ã‚»ã‚­ãƒ¥ã‚¢ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ç®¡ç†

- ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¯HTTP-onlyã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜
- 5åˆ†ã§è‡ªå‹•æœŸé™åˆ‡ã‚Œ
- CSRFä¿è­·

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

- JWT ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
- 30æ—¥é–“æœ‰åŠ¹
- HTTP-only ã‚¯ãƒƒã‚­ãƒ¼
- SameSite=Lax è¨­å®š

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä¿è­·

- æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªå‹•çš„ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ: `/dashboard`, `/my-spells`, `/profile` ãªã©
- å…¬é–‹ãƒ«ãƒ¼ãƒˆ: `/`, `/auth/*`, `/api/webauthn/*`

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ webauthn/
â”‚   â”‚       â”œâ”€â”€ register-options/   # ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
â”‚   â”‚       â”œâ”€â”€ register-verify/    # ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²æ¤œè¨¼
â”‚   â”‚       â”œâ”€â”€ auth-options/       # èªè¨¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
â”‚   â”‚       â””â”€â”€ auth-verify/        # èªè¨¼æ¤œè¨¼
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ signin/                 # ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
â”‚       â””â”€â”€ signup/                 # ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ splash-screen.tsx          # ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
â”‚   â””â”€â”€ providers.tsx              # NextAuth SessionProvider
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ config.ts              # NextAuth è¨­å®š
â””â”€â”€ middleware.ts                  # ãƒ«ãƒ¼ãƒˆä¿è­·ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
```

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### `authenticators` ãƒ†ãƒ¼ãƒ–ãƒ«

```prisma
model authenticators {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
  users                User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}
```

## ğŸŒ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### POST `/api/webauthn/register-options`

ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²ã®ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```json
{
  "email": "user@example.com"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
{
  "options": {
    "challenge": "...",
    "rp": { "name": "Spell Platform", "id": "localhost" },
    "user": { "id": "...", "name": "user@example.com", "displayName": "user" },
    ...
  }
}
```

### POST `/api/webauthn/register-verify`

ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²ã‚’æ¤œè¨¼ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```json
{
  "response": {
    /* WebAuthn RegistrationResponseJSON */
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
{
  "success": true,
  "message": "Passkey registered successfully",
  "userId": "...",
  "email": "user@example.com"
}
```

### POST `/api/webauthn/auth-options`

èªè¨¼ã®ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```json
{} // ç©ºã®ãƒœãƒ‡ã‚£ (Discoverable Credentialsä½¿ç”¨)
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
{
  "options": {
    "challenge": "...",
    "rpId": "localhost",
    ...
  }
}
```

### POST `/api/webauthn/auth-verify`

èªè¨¼ã‚’æ¤œè¨¼ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```json
{
  "response": {
    /* WebAuthn AuthenticationResponseJSON */
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
{
  "success": true,
  "message": "Authentication successful",
  "userId": "...",
  "email": "user@example.com"
}
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ‘ã‚¹ã‚­ãƒ¼ãŒæ©Ÿèƒ½ã—ãªã„

1. **HTTPS ãŒå¿…è¦**: æœ¬ç•ªç’°å¢ƒã§ã¯HTTPSãŒå¿…é ˆã§ã™ (localhostã¯ä¾‹å¤–)
2. **ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆ**: æœ€æ–°ã®Chromeã€Safariã€Edgeã€Firefoxã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
3. **ãƒ‡ãƒã‚¤ã‚¹ã‚µãƒãƒ¼ãƒˆ**: ç”Ÿä½“èªè¨¼ã¾ãŸã¯PINãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ãŒå¿…è¦ã§ã™

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œãªã„

1. `AUTH_SECRET` ãŒ `.env.local` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¯ãƒƒã‚­ãƒ¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
3. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼

```bash
# Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†ç”Ÿæˆ
pnpm prisma generate

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèª
pnpm prisma migrate status

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ (é–‹ç™ºç’°å¢ƒã®ã¿)
pnpm prisma migrate reset
```

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [WebAuthn Guide](https://webauthn.guide/)
- [SimpleWebAuthn Documentation](https://simplewebauthn.dev/)
- [NextAuth.js v5 Documentation](https://next-auth.js.org/)
- [Passkeys Overview](https://www.passkeys.com/)

## ğŸ¯ ä»Šå¾Œã®æ”¹å–„æ¡ˆ

- [ ] è¤‡æ•°ãƒ‘ã‚¹ã‚­ãƒ¼ã®ç™»éŒ²ã‚µãƒãƒ¼ãƒˆ
- [ ] ãƒ‘ã‚¹ã‚­ãƒ¼ã®ç®¡ç†ç”»é¢ (å‰Šé™¤ã€åå‰å¤‰æ›´)
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èªè¨¼æ–¹æ³• (ãƒ¡ãƒ¼ãƒ«èªè¨¼ãªã©)
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ç”»é¢ (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ)
- [ ] ç›£æŸ»ãƒ­ã‚° (èªè¨¼å±¥æ­´ã®è¨˜éŒ²)
