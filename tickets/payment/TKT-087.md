# [TKT-087] Budget Cap Enforcement

## 目的
ユーザーが設定した予算上限（Budget Cap）を厳格に強制し、超過時に実行を拒否（402）。

## スコープ
- `/src/lib/billing/budget.ts`
- `/src/middleware/budget-check.ts`

## 実装詳細

### SPEC-Platform.md セクション参照
- Section 23: Budget Controls & Usage Limits

### SPEC-Implementation.md セクション参照
- Section 7.2: Budget Cap（ハード強制）
- Section 24: エラーコード (BUDGET_CAP_EXCEEDED)

### Budget Cap チェック

```typescript
// budget.ts
import { prisma } from '@/lib/prisma';

export interface BudgetCheckResult {
  allowed: boolean;
  current_usage: number;
  estimated_cost: number;
  cap: number;
  remaining: number;
  period_start: Date;
  period_end?: Date;
}

export class BudgetManager {
  async checkBudget(
    userId: string,
    estimatedCostCents: number
  ): Promise<BudgetCheckResult> {
    // Get user budget
    let budget = await prisma.budget.findUnique({
      where: { userId }
    });

    if (!budget) {
      // Create default budget (no cap)
      budget = await prisma.budget.create({
        data: {
          userId,
          currentMonthCents: 0,
          totalCents: 0,
          periodStart: new Date()
        }
      });
    }

    // Check if period has rolled over
    budget = await this.checkPeriodRollover(budget);

    // Get effective cap (monthly or total)
    const effectiveCap = budget.monthlyCents ?? budget.totalCents ?? Infinity;

    // Calculate remaining budget
    const currentUsage = budget.currentMonthCents;
    const remaining = effectiveCap - currentUsage;

    // Check if estimate fits within cap
    const allowed = currentUsage + estimatedCostCents <= effectiveCap;

    return {
      allowed,
      current_usage: currentUsage,
      estimated_cost: estimatedCostCents,
      cap: effectiveCap,
      remaining,
      period_start: budget.periodStart,
      period_end: budget.periodEnd ?? undefined
    };
  }

  async recordUsage(userId: string, costCents: number): Promise<void> {
    await prisma.budget.update({
      where: { userId },
      data: {
        currentMonthCents: { increment: costCents },
        totalCents: { increment: costCents }
      }
    });

    // Check if cap exceeded
    const budget = await prisma.budget.findUnique({
      where: { userId }
    });

    if (budget) {
      const capExceeded =
        (budget.monthlyCents && budget.currentMonthCents >= budget.monthlyCents) ||
        (budget.totalCents && budget.totalCents >= budget.totalCents);

      if (capExceeded) {
        await prisma.budget.update({
          where: { userId },
          data: { capExceeded: true }
        });
      }
    }
  }

  private async checkPeriodRollover(budget: any): Promise<any> {
    const now = new Date();
    const periodStart = new Date(budget.periodStart);

    // Check if month has changed
    if (
      now.getMonth() !== periodStart.getMonth() ||
      now.getFullYear() !== periodStart.getFullYear()
    ) {
      // Roll over to new period
      return await prisma.budget.update({
        where: { id: budget.id },
        data: {
          currentMonthCents: 0,
          periodStart: new Date(now.getFullYear(), now.getMonth(), 1),
          periodEnd: new Date(now.getFullYear(), now.getMonth() + 1, 0),
          capExceeded: false
        }
      });
    }

    return budget;
  }

  async setCap(
    userId: string,
    type: 'monthly' | 'total',
    capCents: number
  ): Promise<void> {
    const data: any = {};
    if (type === 'monthly') {
      data.monthlyCents = capCents;
    } else {
      data.totalCents = capCents;
    }

    await prisma.budget.upsert({
      where: { userId },
      create: {
        userId,
        ...data,
        currentMonthCents: 0,
        totalCents: 0,
        periodStart: new Date()
      },
      update: data
    });
  }
}
```

### Middleware

```typescript
// budget-check.ts
import { NextRequest } from 'next/server';
import { BudgetManager } from '@/lib/billing/budget';
import { ErrorCatalog } from '@/lib/errors';

export async function budgetCheckMiddleware(
  req: NextRequest,
  ctx: AuthContext,
  estimatedCostCents: number
) {
  const budgetManager = new BudgetManager();

  const result = await budgetManager.checkBudget(ctx.user_id, estimatedCostCents);

  if (!result.allowed) {
    throw ErrorCatalog.BUDGET_CAP_EXCEEDED(
      result.current_usage,
      result.cap,
      result.estimated_cost
    );
  }

  // Attach budget info to request for logging
  req.headers.set('X-Budget-Check', JSON.stringify(result));

  return result;
}
```

## 受け入れ条件
- [ ] Budget model in database
- [ ] Budget cap checking (monthly/total)
- [ ] Period rollover (monthly reset)
- [ ] 402 error on cap exceeded
- [ ] Usage recording after cast
- [ ] Cap exceeded flag
- [ ] Default budget creation
- [ ] Tests with various cap scenarios
- [ ] Tests pass locally
- [ ] Code committed

## 依存関係
blocks: [TKT-088, TKT-164, TKT-174]
blocked-by: [TKT-001]

## 技術スタック
- Prisma
- PostgreSQL
- Next.js middleware

## 優先度
CRITICAL

## 見積もり複雑度
M (Medium)

## セキュリティ考慮事項
- Prevent runaway costs
- Atomic increment for race conditions
- Grace period consideration (optional)
- User notification on cap reached
