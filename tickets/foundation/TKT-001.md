# [TKT-001] Database Schema Migration & Core Tables

## 目的
PostgreSQL/Neon Serverlessのデータベーススキーマを定義し、スペルプラットフォームのコアエンティティを永続化する基盤を構築。

## スコープ
- `/prisma/schema.prisma`
- `/prisma/migrations/`

## 実装詳細

### SPEC-Platform.md セクション参照
- Section 3: System Architecture
- Section 18: Data Model (implicit in ledger/audit sections)
- Appendix A: OpenAPI spec (data models)

### SPEC-Implementation.md セクション参照
- Section 18: データモデル（要旨）

### テーブル設計

```prisma
model User {
  id String @id @default(cuid())
  githubId String @unique
  email String?
  name String?
  avatarUrl String?
  role String @default("caster") // maker, caster, operator, auditor
  status String @default("active") // active, suspended, deleted

  // GDPR/CCPA
  ccpaDoNotSell Boolean @default(false)
  consentVersion String?
  consentedAt DateTime?
  deletedAt DateTime?
  deletionReason String?

  // Billing
  stripeCustomerId String? @unique

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([githubId])
  @@index([stripeCustomerId])
}

model Spell {
  key String @id // com.acme.resize
  name String
  version String // semver
  description String
  authorId String

  // Execution
  executionMode String // workflow, service, clone
  executionConfig Json // varies by mode

  // Pricing
  pricingModel String // flat, metered, one_time
  pricingConfig Json
  currency String @default("USD")

  // Supply Chain
  sbomIncluded Boolean @default(false)
  sbomFormat String? // spdx-json, cyclonedx-json
  sbomUrl String?
  dependencyScanPassed Boolean @default(false)
  signatureUrl String? // Sigstore bundle

  // Metadata
  repository String?
  license String?
  tags String[]
  category String?
  visibility String @default("public") // public, unlisted, private

  // Status
  status String @default("draft") // draft, published, suspended
  publishedAt DateTime?
  suspendedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, version])
  @@index([authorId])
  @@index([status])
  @@index([category])
}

model Cast {
  id String @id @default(cuid())
  spellKey String
  spellVersion String
  casterId String

  // Execution
  inputHash String // SHA256 of input
  mode String // workflow, service
  status String // queued, running, succeeded, failed, timeout
  runUrl String? // GitHub Actions URL or internal
  artifactUrl String?

  // Resource Tracking
  startedAt DateTime?
  finishedAt DateTime?
  durationMs Int?
  cpuCycles BigInt?
  memoryPeakBytes BigInt?
  networkBytesSent BigInt?
  networkBytesReceived BigInt?

  // Billing
  costCents Int?
  billingStatus String? // pending, charged, refunded

  // Region
  region String?

  // Idempotency
  idempotencyKey String @unique

  // Timestamps
  createdAt DateTime @default(now())

  @@index([spellKey])
  @@index([casterId])
  @@index([status])
  @@index([createdAt])
}

model Budget {
  id String @id @default(cuid())
  userId String @unique

  // Caps
  monthlyCents Int? // Monthly spending cap
  totalCents Int? // Total lifetime cap

  // Usage
  currentMonthCents Int @default(0)
  totalCents Int @default(0)

  // Period
  periodStart DateTime @default(now())
  periodEnd DateTime?

  // Status
  capExceeded Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ApiKey {
  id String @id @default(cuid())
  userId String
  name String
  keyHash String @unique
  keyPrefix String // First 8 chars for display

  scopes String[] // spell:publish, cast:invoke, ops:deploy, audit:read

  status String @default("active") // active, revoked
  expiresAt DateTime?
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([keyHash])
}

model PolicyViolation {
  id String @id @default(cuid())
  spellKey String
  castId String?

  violationType String // network, fs, timeout, memory
  details String
  severity String // low, medium, high, critical

  createdAt DateTime @default(now())

  @@index([spellKey])
  @@index([createdAt])
}

model DataTransferConsent {
  id String @id @default(cuid())
  userId String

  transferType String // eu_us, us_jp, etc
  mechanism String // scc, adequacy, dpf
  consentedAt DateTime @default(now())
  consentVersion String

  @@index([userId])
}
```

## 受け入れ条件
- [ ] Prisma schema定義完了
- [ ] `prisma migrate dev` 成功
- [ ] All tables created in Neon PostgreSQL
- [ ] Indexes created for performance
- [ ] GDPR/CCPA fields present in User model
- [ ] Supply chain fields present in Spell model
- [ ] Tests pass locally
- [ ] Code committed

## 依存関係
blocks: [TKT-002, TKT-003, TKT-004, TKT-005]
blocked-by: []

## 技術スタック
- PostgreSQL 16+ (Neon Serverless)
- Prisma ORM
- TypeScript

## 優先度
CRITICAL

## 見積もり複雑度
L (Large)

## セキュリティ考慮事項
- API keys stored as hashed values (keyHash)
- Input stored as hash only (inputHash) for privacy
- GDPR/CCPA compliance fields mandatory
- Audit trail via timestamps and status fields
