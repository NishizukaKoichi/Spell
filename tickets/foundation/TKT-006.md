# [TKT-006] Error Catalog Implementation

## 目的

統一されたエラーコード体系とレスポンス形式を実装。

## スコープ

- `/src/lib/errors.ts`
- `/src/types/errors.ts`

## 実装詳細

### SPEC-Platform.md セクション参照

- Section 29: Error Catalog

### SPEC-Implementation.md セクション参照

- Section 24: エラーコード

### エラーカタログ

```typescript
// errors.ts
export class SpellError extends Error {
  constructor(
    public code: string,
    public message: string,
    public httpStatus: number,
    public details?: Record<string, any>
  ) {
    super(message);
    this.name = 'SpellError';
  }

  toJSON() {
    return {
      error: {
        code: this.code,
        message: this.message,
        ...(this.details && { details: this.details }),
      },
    };
  }
}

export const ErrorCatalog = {
  // Authentication & Authorization (4xx)
  UNAUTHORIZED: (msg = 'Authentication required') => new SpellError('UNAUTHORIZED', msg, 401),

  FORBIDDEN: (msg = 'Insufficient permissions') => new SpellError('FORBIDDEN', msg, 403),

  FORBIDDEN_REPO: (repo: string) =>
    new SpellError(
      'FORBIDDEN_REPO',
      `Repository ${repo} not accessible. Install GitHub App and grant permissions.`,
      403,
      { repo }
    ),

  // Payment & Budget (402)
  BUDGET_CAP_EXCEEDED: (current: number, cap: number, estimate: number) =>
    new SpellError('BUDGET_CAP_EXCEEDED', 'Budget cap exceeded', 402, {
      current_usage: current,
      cap,
      estimate,
      retry_after: 86400,
    }),

  PAYMENT_REQUIRED: (msg = 'Payment method required') =>
    new SpellError('PAYMENT_REQUIRED', msg, 402),

  // Not Found (404)
  SPELL_NOT_FOUND: (key: string) =>
    new SpellError('SPELL_NOT_FOUND', `Spell ${key} not found`, 404, { key }),

  WORKFLOW_NOT_FOUND: (workflowId: string) =>
    new SpellError('WORKFLOW_NOT_FOUND', `Workflow ${workflowId} not found in repository`, 404, {
      workflow_id: workflowId,
    }),

  ARTIFACT_EXPIRED: (runId: string) =>
    new SpellError('ARTIFACT_EXPIRED', 'Artifact has expired (TTL exceeded)', 410, {
      run_id: runId,
    }),

  // Conflict (409)
  IDEMPOTENCY_CONFLICT: (key: string) =>
    new SpellError(
      'IDEMPOTENCY_CONFLICT',
      'Duplicate idempotency key with different request body',
      409,
      { idempotency_key: key }
    ),

  // Validation (422)
  VALIDATION_ERROR: (errors: Record<string, string[]>) =>
    new SpellError('VALIDATION_ERROR', 'Input validation failed', 422, {
      validation_errors: errors,
    }),

  // Rate Limiting (429)
  RATE_LIMITED: (retryAfter: number) =>
    new SpellError('RATE_LIMITED', 'Rate limit exceeded', 429, { retry_after: retryAfter }),

  // Server Errors (5xx)
  INTERNAL: (msg = 'Internal server error') => new SpellError('INTERNAL', msg, 500),

  TIMEOUT: (maxSeconds: number) =>
    new SpellError('TIMEOUT', `Execution timeout after ${maxSeconds}s`, 504, {
      timeout_sec: maxSeconds,
    }),

  SERVICE_UNAVAILABLE: (msg = 'Service temporarily unavailable') =>
    new SpellError('SERVICE_UNAVAILABLE', msg, 503),
};

export function handleError(error: unknown): Response {
  if (error instanceof SpellError) {
    return new Response(JSON.stringify(error.toJSON()), {
      status: error.httpStatus,
      headers: { 'Content-Type': 'application/json' },
    });
  }

  // Unknown error
  console.error('Unhandled error:', error);
  return new Response(
    JSON.stringify({
      error: {
        code: 'INTERNAL',
        message: 'Internal server error',
      },
    }),
    {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    }
  );
}
```

## 受け入れ条件

- [ ] All error codes from SPEC implemented
- [ ] SpellError class with toJSON()
- [ ] ErrorCatalog factory functions
- [ ] Consistent error response format
- [ ] HTTP status codes match spec
- [ ] Error details included where appropriate
- [ ] Global error handler
- [ ] Tests pass locally
- [ ] Code committed

## 依存関係

blocks: [TKT-161, TKT-162, TKT-163]
blocked-by: []

## 技術スタック

- TypeScript
- Custom Error classes

## 優先度

HIGH

## 見積もり複雑度

S (Small)
