# [TKT-002] Core Data Models & DTOs

## 目的

TypeScriptでSpell、Cast、User、Budgetなどのコアドメインモデルとデータ転送オブジェクト（DTO）を実装。

## スコープ

- `/src/types/spell.ts`
- `/src/types/cast.ts`
- `/src/types/user.ts`
- `/src/types/budget.ts`
- `/src/types/api.ts`

## 実装詳細

### SPEC-Platform.md セクション参照

- Section 2.1: Terminology
- Section 5: Spell Definition
- Section 7: Manifest Format

### SPEC-Implementation.md セクション参照

- Section 18: データモデル（要旨）
- Section 19: 付録：API スキーマ断片

### 型定義例

```typescript
// spell.ts
export type ExecutionMode = 'workflow' | 'service' | 'clone';

export interface WorkflowExecution {
  repo: string;
  workflow_id: string;
  dispatch: 'workflow_dispatch' | 'repository_dispatch';
}

export interface ServiceExecution {
  runtime: 'wasm' | 'container';
  timeout_ms: number;
  max_memory_mb: number;
  max_output_mb: number;
}

export interface CloneExecution {
  template_repo: string;
  license_url?: string;
}

export interface Spell {
  key: string;
  name: string;
  version: string;
  description: string;
  author_id: string;

  execution: {
    mode: ExecutionMode;
    workflow?: WorkflowExecution;
    service?: ServiceExecution;
    clone?: CloneExecution;
  };

  pricing: {
    model: 'flat' | 'metered' | 'one_time';
    currency: string;
    flat_cents?: number;
    base_cents?: number;
    metered?: {
      dimension: 'casts' | 'compute_ms' | 'egress_mb';
      price_per_unit_cents: number;
    };
  };

  inputs: JSONSchema;
  tags: string[];
  category?: string;
  visibility: 'public' | 'unlisted' | 'private';

  // Supply Chain
  sbom_included: boolean;
  sbom_format?: 'spdx-json' | 'cyclonedx-json';
  sbom_url?: string;
  dependency_scan_passed: boolean;
  signature_url?: string;

  status: 'draft' | 'published' | 'suspended';
  published_at?: string;
  created_at: string;
  updated_at: string;
}

// cast.ts
export interface CastRequest {
  spell_id: string;
  inputs: Record<string, any>;
  mode?: ExecutionMode;
  budget_cap?: number;
  idempotency_key: string;
}

export interface Cast {
  id: string;
  spell_key: string;
  spell_version: string;
  caster_id: string;

  input_hash: string;
  mode: string;
  status: 'queued' | 'running' | 'succeeded' | 'failed' | 'timeout';
  run_url?: string;
  artifact_url?: string;

  started_at?: string;
  finished_at?: string;
  duration_ms?: number;

  cost_cents?: number;
  billing_status?: 'pending' | 'charged' | 'refunded';

  created_at: string;
}

// budget.ts
export interface Budget {
  id: string;
  user_id: string;

  monthly_cents?: number;
  total_cents?: number;

  current_month_cents: number;
  total_cents_spent: number;

  period_start: string;
  period_end?: string;

  cap_exceeded: boolean;

  created_at: string;
  updated_at: string;
}

export interface BudgetCheckResult {
  allowed: boolean;
  current_usage: number;
  estimated_cost: number;
  cap: number;
  remaining: number;
}

// user.ts
export interface User {
  id: string;
  github_id: string;
  email?: string;
  name?: string;
  avatar_url?: string;
  role: 'maker' | 'caster' | 'operator' | 'auditor';
  status: 'active' | 'suspended' | 'deleted';

  ccpa_do_not_sell: boolean;
  consent_version?: string;
  consented_at?: string;

  stripe_customer_id?: string;

  created_at: string;
  updated_at: string;
}

// api.ts
export interface ApiError {
  error: {
    code: string;
    message: string;
    retry_after?: number;
    details?: Record<string, any>;
  };
}

export interface PaginatedResponse<T> {
  items: T[];
  total: number;
  page: number;
  page_size: number;
  has_more: boolean;
}
```

## 受け入れ条件

- [ ] All core types defined
- [ ] JSON Schema types for spell inputs/outputs
- [ ] DTO types for API requests/responses
- [ ] Zod schemas for runtime validation
- [ ] Type exports properly configured
- [ ] Tests pass locally
- [ ] Code committed

## 依存関係

blocks: [TKT-003, TKT-004, TKT-161]
blocked-by: [TKT-001]

## 技術スタック

- TypeScript 5.x
- Zod (runtime validation)
- JSON Schema

## 優先度

CRITICAL

## 見積もり複雑度

M (Medium)
