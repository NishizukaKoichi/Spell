# [TKT-041] WASM Module Loader with Caching

## 目的

WASMモジュールのロード、検証、コンパイル、キャッシングを実装し、高速な実行を実現。

## スコープ

- `/src/lib/wasm/loader.ts`
- `/src/lib/wasm/cache.ts`

## 実装詳細

### SPEC-Platform.md セクション参照

- Section 8: WASM Binary Requirements
- Section 10: Execution Environment
- Section 10.1: WASM Runtime Configuration

### モジュールローダー

```typescript
// loader.ts
import { readFile } from 'fs/promises';
import { createHash } from 'crypto';

export interface WASMModule {
  hash: string;
  bytes: Uint8Array;
  size: number;
  compiled?: WebAssembly.Module;
}

export class WASMLoader {
  private cache: Map<string, WebAssembly.Module> = new Map();

  async loadModule(path: string): Promise<WASMModule> {
    // 1. Read WASM binary
    const bytes = await readFile(path);

    // 2. Validate size (5MB limit)
    if (bytes.length > 5 * 1024 * 1024) {
      throw new Error('WASM binary exceeds 5MB limit');
    }

    // 3. Calculate hash
    const hash = createHash('sha256').update(bytes).digest('hex');

    // 4. Check cache
    const cached = this.cache.get(hash);
    if (cached) {
      return {
        hash,
        bytes: new Uint8Array(bytes),
        size: bytes.length,
        compiled: cached,
      };
    }

    // 5. Validate WASM
    if (!this.isValidWASM(bytes)) {
      throw new Error('Invalid WASM binary');
    }

    return {
      hash,
      bytes: new Uint8Array(bytes),
      size: bytes.length,
    };
  }

  async compileModule(module: WASMModule): Promise<WebAssembly.Module> {
    if (module.compiled) {
      return module.compiled;
    }

    // Compile with timeout (30s)
    const compiled = await Promise.race([
      WebAssembly.compile(module.bytes),
      new Promise<never>((_, reject) =>
        setTimeout(() => reject(new Error('Compilation timeout')), 30000)
      ),
    ]);

    // Cache compiled module
    this.cache.set(module.hash, compiled);

    return compiled;
  }

  private isValidWASM(bytes: Uint8Array): boolean {
    // Check magic number: 0x00 0x61 0x73 0x6D (\0asm)
    return (
      bytes.length >= 4 &&
      bytes[0] === 0x00 &&
      bytes[1] === 0x61 &&
      bytes[2] === 0x73 &&
      bytes[3] === 0x6d
    );
  }

  clearCache(): void {
    this.cache.clear();
  }

  getCacheSize(): number {
    return this.cache.size;
  }
}
```

### Redis-backed Cache (Production)

```typescript
// cache.ts
import { Redis } from '@upstash/redis';

export class WASMCache {
  private redis: Redis;

  constructor() {
    this.redis = new Redis({
      url: process.env.UPSTASH_REDIS_URL!,
      token: process.env.UPSTASH_REDIS_TOKEN!,
    });
  }

  async getCompiled(hash: string): Promise<ArrayBuffer | null> {
    const key = `wasm:compiled:${hash}`;
    const cached = await this.redis.get(key);

    if (!cached) return null;

    // Return as ArrayBuffer
    return Buffer.from(cached as string, 'base64').buffer;
  }

  async setCompiled(hash: string, compiled: ArrayBuffer): Promise<void> {
    const key = `wasm:compiled:${hash}`;
    const base64 = Buffer.from(compiled).toString('base64');

    // Cache for 7 days
    await this.redis.setex(key, 7 * 24 * 3600, base64);
  }

  async has(hash: string): Promise<boolean> {
    const key = `wasm:compiled:${hash}`;
    const exists = await this.redis.exists(key);
    return exists === 1;
  }
}
```

## 受け入れ条件

- [ ] WASM binary validation (magic number)
- [ ] Size limit enforcement (5MB)
- [ ] SHA256 hash calculation
- [ ] In-memory cache for compiled modules
- [ ] Redis-backed cache for persistence
- [ ] AOT compilation with timeout (30s)
- [ ] Cache hit metrics
- [ ] Tests with valid/invalid WASM
- [ ] Tests pass locally
- [ ] Code committed

## 依存関係

blocks: [TKT-042, TKT-047, TKT-049]
blocked-by: [TKT-007]

## 技術スタック

- WebAssembly API
- Redis (Upstash)
- SHA-256 hashing
- TypeScript

## 優先度

CRITICAL

## 見積もり複雑度

L (Large)

## セキュリティ考慮事項

- Validate WASM magic number
- Size limits prevent memory exhaustion
- Hash-based cache prevents collision
- Timeout on compilation prevents DoS
