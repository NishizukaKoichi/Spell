# [TKT-021] Sigstore Integration (Fulcio + Rekor)

## 目的

Sigstore（Fulcio + Rekor）を統合し、Spellパッケージの署名と検証を実装。

## スコープ

- `/src/lib/sigstore/sign.ts`
- `/src/lib/sigstore/verify.ts`
- `/src/lib/sigstore/rekor.ts`

## 実装詳細

### SPEC-Platform.md セクション参照

- Section 9.2: Sigstore Integration (Fulcio + Rekor)
- Section 9.3: Supply Chain Security

### 署名フロー (Maker側)

```typescript
// sign.ts - For CLI/CI
import { execSync } from 'child_process';
import { readFileSync, writeFileSync } from 'fs';

export async function signSpellPackage(
  tarPath: string,
  outputPath: string
): Promise<SignatureBundle> {
  // Use cosign CLI for signing
  // In production, this runs in GitHub Actions
  const cmd = `cosign sign-blob ${tarPath} \
    --bundle ${outputPath} \
    --oidc-issuer=https://github.com/login/oauth \
    --yes`;

  execSync(cmd, { stdio: 'inherit' });

  const bundle = JSON.parse(readFileSync(outputPath, 'utf-8'));

  return {
    signature_url: outputPath,
    rekor_index: bundle.rekorBundle.Payload.logIndex,
    rekor_uuid: bundle.rekorBundle.Payload.logID,
    cert_identity: extractIdentity(bundle.cert),
  };
}

function extractIdentity(cert: string): string {
  // Extract GitHub identity from Fulcio certificate
  // Format: https://github.com/{owner}/{repo}/.github/workflows/{workflow}.yml@refs/...
  const match = cert.match(/github\.com\/([^\/]+)\/([^\/]+)/);
  return match ? `${match[1]}/${match[2]}` : 'unknown';
}
```

### 検証フロー (Platform側)

```typescript
// verify.ts
import { createHash } from 'crypto';

export interface VerificationResult {
  verified: boolean;
  signed_by: string;
  signed_at: Date;
  rekor_index: number;
  rekor_verified: boolean;
  errors?: string[];
}

export async function verifySpellSignature(
  tarBytes: Buffer,
  signatureBundle: any
): Promise<VerificationResult> {
  const errors: string[] = [];

  // 1. Verify signature using cosign
  try {
    const tempTar = '/tmp/spell-verify.tar';
    const tempSig = '/tmp/spell-signature.json';

    writeFileSync(tempTar, tarBytes);
    writeFileSync(tempSig, JSON.stringify(signatureBundle));

    execSync(`cosign verify-blob ${tempTar} --bundle ${tempSig}`, {
      stdio: 'pipe',
    });
  } catch (e) {
    errors.push('Signature verification failed');
    return {
      verified: false,
      signed_by: 'unknown',
      signed_at: new Date(0),
      rekor_index: 0,
      rekor_verified: false,
      errors,
    };
  }

  // 2. Verify Rekor entry
  const rekorVerified = await verifyRekorEntry(signatureBundle.rekorBundle.Payload);

  if (!rekorVerified) {
    errors.push('Rekor entry verification failed');
  }

  // 3. Extract metadata
  const signedBy = extractIdentity(signatureBundle.cert);
  const signedAt = new Date(signatureBundle.rekorBundle.Payload.integratedTime * 1000);
  const rekorIndex = signatureBundle.rekorBundle.Payload.logIndex;

  return {
    verified: errors.length === 0,
    signed_by: signedBy,
    signed_at: signedAt,
    rekor_index: rekorIndex,
    rekor_verified: rekorVerified,
    errors: errors.length > 0 ? errors : undefined,
  };
}

async function verifyRekorEntry(rekorPayload: any): Promise<boolean> {
  try {
    // Query Rekor public log
    const response = await fetch(
      `https://rekor.sigstore.dev/api/v1/log/entries/${rekorPayload.logID}/${rekorPayload.logIndex}`
    );

    if (!response.ok) return false;

    const entry = await response.json();

    // Verify entry matches our payload
    const entryHash = createHash('sha256').update(JSON.stringify(entry)).digest('hex');

    return entryHash === rekorPayload.bodyHash;
  } catch {
    return false;
  }
}
```

### DB保存

```typescript
// Save verification result
await prisma.spell.update({
  where: { key: spellKey },
  data: {
    signatureUrl: signatureBundle.signature_url,
    signatureVerified: verificationResult.verified,
    signedBy: verificationResult.signed_by,
    signedAt: verificationResult.signed_at,
    rekorIndex: verificationResult.rekor_index,
  },
});
```

## 受け入れ条件

- [ ] Cosign CLI integrated
- [ ] Sign workflow in GitHub Actions template
- [ ] Verify function for uploaded spells
- [ ] Rekor entry verification
- [ ] Certificate identity extraction
- [ ] Signature metadata stored in DB
- [ ] Rejection of unsigned spells (warning → error migration)
- [ ] Tests with real Sigstore
- [ ] Tests pass locally
- [ ] Code committed

## 依存関係

blocks: [TKT-023]
blocked-by: [TKT-001]

## 技術スタック

- Sigstore (cosign CLI)
- Fulcio (certificate authority)
- Rekor (transparency log)
- Node.js child_process

## 優先度

HIGH

## 見積もり複雑度

L (Large)

## セキュリティ考慮事項

- Keyless signing via OIDC
- Short-lived certificates (15 min)
- Public transparency log (immutable)
- GitHub identity verification
- Certificate chain validation
