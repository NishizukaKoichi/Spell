# [TKT-022] SBOM Generation Pipeline

## 目的
Spell作成時にSBOM (Software Bill of Materials) を自動生成するCI/CDパイプラインを実装。

## スコープ
- `/.github/workflows/sbom-generation.yml`
- `/scripts/generate-sbom.sh`
- Documentation in `/docs/sbom-guide.md`

## 実装詳細

### SPEC-Platform.md セクション参照
- Section 9.4: SBOM (Software Bill of Materials) - REQUIRED
- Section 9.4.1: SBOM Generation

### GitHub Actions ワークフロー

```yaml
# .github/workflows/sbom-generation.yml
name: Generate SBOM

on:
  workflow_call:
    inputs:
      spell_dir:
        required: true
        type: string
    outputs:
      sbom_path:
        value: ${{ jobs.generate.outputs.sbom_path }}

jobs:
  generate:
    runs-on: ubuntu-24.04
    outputs:
      sbom_path: ${{ steps.generate.outputs.path }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect language
        id: detect
        run: |
          if [ -f "${{ inputs.spell_dir }}/Cargo.toml" ]; then
            echo "language=rust" >> $GITHUB_OUTPUT
          elif [ -f "${{ inputs.spell_dir }}/package.json" ]; then
            echo "language=javascript" >> $GITHUB_OUTPUT
          elif [ -f "${{ inputs.spell_dir }}/requirements.txt" ] || [ -f "${{ inputs.spell_dir }}/pyproject.toml" ]; then
            echo "language=python" >> $GITHUB_OUTPUT
          elif [ -f "${{ inputs.spell_dir }}/go.mod" ]; then
            echo "language=go" >> $GITHUB_OUTPUT
          else
            echo "language=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Generate SBOM (Rust)
        if: steps.detect.outputs.language == 'rust'
        run: |
          cargo install cargo-sbom
          cd ${{ inputs.spell_dir }}
          cargo sbom --output-format spdx-json > sbom.spdx.json

      - name: Generate SBOM (JavaScript)
        if: steps.detect.outputs.language == 'javascript'
        run: |
          npm install -g @cyclonedx/cyclonedx-npm
          cd ${{ inputs.spell_dir }}
          cyclonedx-npm --output-file sbom.json
          # Convert to SPDX if needed

      - name: Generate SBOM (Python)
        if: steps.detect.outputs.language == 'python'
        run: |
          pip install cyclonedx-bom
          cd ${{ inputs.spell_dir }}
          cyclonedx-py -o sbom.json

      - name: Generate SBOM (Go)
        if: steps.detect.outputs.language == 'go'
        run: |
          go install github.com/CycloneDX/cyclonedx-gomod/cmd/cyclonedx-gomod@latest
          cd ${{ inputs.spell_dir }}
          cyclonedx-gomod app -output sbom.json

      - name: Generate SBOM (Syft - Fallback)
        if: steps.detect.outputs.language == 'unknown'
        uses: anchore/sbom-action@v0
        with:
          path: ${{ inputs.spell_dir }}
          format: spdx-json
          output-file: ${{ inputs.spell_dir }}/sbom.spdx.json

      - name: Validate SBOM
        run: |
          # Basic validation
          SBOM_FILE=$(find ${{ inputs.spell_dir }} -name "sbom*.json" | head -1)
          if [ ! -f "$SBOM_FILE" ]; then
            echo "Error: SBOM not generated"
            exit 1
          fi

          # Check JSON validity
          jq empty "$SBOM_FILE"

          # Check required fields
          if jq -e '.packages | length > 0' "$SBOM_FILE" > /dev/null; then
            echo "SBOM validation passed"
            echo "path=$SBOM_FILE" >> $GITHUB_OUTPUT
          else
            echo "Error: SBOM contains no packages"
            exit 1
          fi
        id: generate

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: ${{ steps.generate.outputs.path }}
          retention-days: 90
```

### CLI Script (ローカル開発用)

```bash
#!/bin/bash
# scripts/generate-sbom.sh

set -e

SPELL_DIR=${1:-.}

echo "Generating SBOM for $SPELL_DIR..."

# Detect language
if [ -f "$SPELL_DIR/Cargo.toml" ]; then
  echo "Detected: Rust"
  cargo sbom --output-format spdx-json > "$SPELL_DIR/sbom.spdx.json"
elif [ -f "$SPELL_DIR/package.json" ]; then
  echo "Detected: JavaScript/Node"
  npx @cyclonedx/cyclonedx-npm --output-file "$SPELL_DIR/sbom.json"
elif [ -f "$SPELL_DIR/go.mod" ]; then
  echo "Detected: Go"
  cyclonedx-gomod app -output "$SPELL_DIR/sbom.json"
else
  echo "Using Syft (multi-language)"
  syft packages "$SPELL_DIR" -o spdx-json > "$SPELL_DIR/sbom.spdx.json"
fi

echo "SBOM generated successfully"
```

## 受け入れ条件
- [ ] GitHub Actions workflow for SBOM generation
- [ ] Support for Rust, JavaScript, Python, Go
- [ ] Fallback to Syft for unknown languages
- [ ] SBOM validation step
- [ ] Upload as artifact
- [ ] Local CLI script for developers
- [ ] Documentation for makers
- [ ] Tests with sample projects
- [ ] Tests pass locally
- [ ] Code committed

## 依存関係
blocks: [TKT-023]
blocked-by: []

## 技術スタック
- cargo-sbom (Rust)
- cyclonedx-npm (JavaScript)
- cyclonedx-bom (Python)
- cyclonedx-gomod (Go)
- Syft (multi-language fallback)
- SPDX/CycloneDX formats

## 優先度
HIGH

## 見積もり複雑度
M (Medium)
